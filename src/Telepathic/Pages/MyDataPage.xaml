<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:pageModels="clr-namespace:Telepathic.PageModels"
             xmlns:models="clr-namespace:Telepathic.Models"
             xmlns:memory="clr-namespace:Telepathic.Data.UserMemory"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="Telepathic.Pages.MyDataPage"
             x:DataType="pageModels:MyDataPageModel"
             x:Name="MyDataPageRef"
             Title="My Data">

    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior
            BindingContext="{Binding Path=BindingContext, Source={x:Reference MyDataPageRef}, x:DataType=ContentPage}"
            EventName="NavigatedTo"
            Command="{Binding LoadDataCommand}"/>
    </ContentPage.Behaviors>

    <ScrollView>
        <VerticalStackLayout Padding="24"
                             Spacing="24">

            <Label Text="ðŸ§  My Memory"
                   FontAttributes="Bold"
                   FontSize="28"
                   HorizontalOptions="Center"
                   Margin="0,0,0,12"/>

            <!-- Statistics Section -->
            <Border StrokeThickness="1"
                    Stroke="{toolkit:AppThemeResource Surface1}"
                    StrokeShape="RoundRectangle 12"
                    BackgroundColor="{toolkit:AppThemeResource Surface0}"
                    Padding="16">
                <VerticalStackLayout Spacing="12">
                    <Label Text="ðŸ“ˆ Statistics"
                           FontAttributes="Bold"
                           FontSize="20"/>

                    <Grid ColumnDefinitions="*, Auto"
                          RowDefinitions="Auto, Auto, Auto, Auto"
                          RowSpacing="8">
                        <Label Text="Total Events:"
                               Grid.Row="0"
                               Grid.Column="0"/>
                        <Label Text="{Binding TotalEvents}"
                               Grid.Row="0"
                               Grid.Column="1"
                               FontAttributes="Bold"/>

                        <Label Text="Total Facts:"
                               Grid.Row="1"
                               Grid.Column="0"/>
                        <Label Text="{Binding TotalFacts}"
                               Grid.Row="1"
                               Grid.Column="1"
                               FontAttributes="Bold"/>

                        <Label Text="Snapshot Version:"
                               Grid.Row="2"
                               Grid.Column="0"/>
                        <Label Text="{Binding SnapshotVersion}"
                               Grid.Row="2"
                               Grid.Column="1"
                               FontAttributes="Bold"/>

                        <Label Text="Last Updated:"
                               Grid.Row="3"
                               Grid.Column="0"/>
                        <Label Text="{Binding LastUpdated}"
                               Grid.Row="3"
                               Grid.Column="1"
                               FontAttributes="Bold"/>
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <!-- Current Snapshot Section -->
            <Border StrokeThickness="1"
                    Stroke="{toolkit:AppThemeResource Surface1}"
                    StrokeShape="RoundRectangle 12"
                    BackgroundColor="{toolkit:AppThemeResource Surface0}"
                    Padding="16">
                <VerticalStackLayout Spacing="12">
                    <Label Text="ðŸ“¸ Current Snapshot"
                           FontAttributes="Bold"
                           FontSize="20"/>

                    <Label Text="{Binding SnapshotText}"
                           LineBreakMode="WordWrap"
                           FontFamily="Courier"
                           FontSize="12"
                           TextColor="{toolkit:AppThemeResource OnBackground}"/>
                </VerticalStackLayout>
            </Border>

            <!-- Facts Section -->
            <Border StrokeThickness="1"
                    Stroke="{toolkit:AppThemeResource Surface1}"
                    StrokeShape="RoundRectangle 12"
                    BackgroundColor="{toolkit:AppThemeResource Surface0}"
                    Padding="16">
                <VerticalStackLayout Spacing="12">
                    <Label Text="ðŸ’¡ Facts"
                           FontAttributes="Bold"
                           FontSize="20"/>

                    <CollectionView ItemsSource="{Binding Facts}"
                                    EmptyView="No facts recorded yet.">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="memory:MemoryFact">
                                <Grid ColumnDefinitions="*, Auto"
                                      Padding="8,4"
                                      ColumnSpacing="12">
                                    <VerticalStackLayout Grid.Column="0"
                                                         Spacing="2">
                                        <Label Text="{Binding Key}"
                                               FontAttributes="Bold"/>
                                        <Label Text="{Binding Value}"
                                               FontSize="12"
                                               TextColor="{toolkit:AppThemeResource OnSurfaceVariant}"/>
                                    </VerticalStackLayout>
                                    <Label Grid.Column="1"
                                           Text="{Binding Score, StringFormat='{0:F2}'}"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"
                                           TextColor="{toolkit:AppThemeResource Primary}"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>

            <!-- Recent Events Section -->
            <Border StrokeThickness="1"
                    Stroke="{toolkit:AppThemeResource Surface1}"
                    StrokeShape="RoundRectangle 12"
                    BackgroundColor="{toolkit:AppThemeResource Surface0}"
                    Padding="16">
                <VerticalStackLayout Spacing="12">
                    <Label Text="ðŸ“‹ Recent Events (Last 20)"
                           FontAttributes="Bold"
                           FontSize="20"/>

                    <CollectionView ItemsSource="{Binding RecentEvents}"
                                    EmptyView="No events recorded yet.">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="memory:MemoryEvent">
                                <Grid ColumnDefinitions="Auto, *"
                                      Padding="8,4"
                                      ColumnSpacing="12">
                                    <Label Grid.Column="0"
                                           Text="{Binding Type}"
                                           FontAttributes="Bold"
                                           FontSize="12"
                                           VerticalOptions="Center"
                                           TextColor="{toolkit:AppThemeResource Secondary}"/>
                                    <VerticalStackLayout Grid.Column="1"
                                                         Spacing="2">
                                        <Label Text="{Binding Topic}"
                                               FontSize="12"/>
                                        <Label Text="{Binding AtUtc, StringFormat='{0:MMM d, h:mm tt}'}"
                                               FontSize="10"
                                               TextColor="{toolkit:AppThemeResource OnSurfaceVariant}"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>

            <!-- Action Buttons -->
            <Button Text="ðŸ”„ Refresh Snapshot"
                    Command="{Binding RefreshSnapshotCommand}"
                    BackgroundColor="{toolkit:AppThemeResource Primary}"
                    TextColor="{toolkit:AppThemeResource OnPrimary}"/>

            <Button Text="ðŸ—‘ï¸ Forget Me"
                    Command="{Binding ForgetMeCommand}"
                    BackgroundColor="{toolkit:AppThemeResource Error}"
                    TextColor="{toolkit:AppThemeResource OnError}"/>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
